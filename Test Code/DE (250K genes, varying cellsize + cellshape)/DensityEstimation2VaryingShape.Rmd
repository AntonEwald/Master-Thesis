---
title: "DensityEstimation2VaryingShape"
author: "Anton Holm"
date: '2022-03-19'
output: html_document
---

Here we generate GMM sample with varying shape of the cells.

```{r, eval = FALSE}
#### Generates a GMM data sample ####
 # No need to run this code
source("..\\Generate_GMM_Data.R")
gauss_VS <- Generate_GMM_Data(n = 135000, clusters = 540, tissue_x = 600, tissue_y = 900, Cellwidth = 11.6, Mode = 3)
 saveRDS(gauss_VS, file = "GMM_data_varying_shape.rdata")
########################################
```

Load all needed objects
```{r}
#### Load the saved data ####
GMM_data_VS <- readRDS("GMM_data_varying_shape.rdata")
GMM_coordinates_VS <- GMM_data_VS[[1]]
True_density_VS <- GMM_data_VS[[2]]
mu_VS <- GMM_data_VS[[3]]
GMM_sample_VS <- GMM_data_VS[[4]]

#Elements are d_ij
  Adjacency_Matrix_VS <- kNNdist(GMM_coordinates_VS, k = 7, all = TRUE)
  #saveRDS(Adjacency_Matrix, file = "Adjacency_Matrix.rda")
#Adjacency_Matrix_VS <- readRDS("ADjacency_Matrix_VS.rda")
##############################
```

Here we can see how the data looks like
```{r}
sample_vec_VS <- c()
for(i in 1:length(GMM_sample_VS)){
  sample_vec_VS <- c(sample_vec_VS, rep(i, GMM_sample_VS[[i]][1]))
}

GMM_coordinates_VS %>% 
  as_tibble() %>% 
  mutate(Gaussian = as.factor(sample_vec_VS)) %>% 
  filter(Gaussian %in% 1:540) %>% 
  ggplot(aes(x = V1, y = V2, col = Gaussian)) +
  geom_point(size = 1) +
  guides(col = "none")
```


Same density estimators as for large dataset
```{r}
#Density Estimations
Density_Vector1_VS <- 1/rowSums(Adjacency_Matrix_VS)
Density_vector2_VS <- 1/(1 + rowSums(Adjacency_Matrix_VS^2))

kernel <- function(x, h){
  1/(2*pi*h^2) * exp(-1/2 * (x/h)^2)
}
#Calculate euclidean distance to all k-nearest neighbors (list with each gene-type in the list)
knn_distance_VS <- kNNdist(GMM_coordinates_VS, k = 50, all = TRUE)
kde_dens_VS <- kernel(knn_distance_VS, h = 2.5) %>% 
  rowSums()
##############################
```


And now the Loop which takes time

```{r}
Estimated_modes1_VS <- matrix(NA, nrow = 540, ncol = 6)
Estimated_modes2_VS <- matrix(NA, nrow = 540, ncol = 6)
Estimated_modes3_VS <- matrix(NA, nrow = 540, ncol = 6)

for (i in 1:540) {
  M <- cbind(1:nrow(GMM_coordinates_VS), apply(GMM_coordinates_VS, MARGIN = 1, FUN = function(x) sqrt(sum((x[]-mu_VS[i,])^2))), Density_Vector1_VS, Density_vector2_VS, kde_dens_VS)
  ordered <- M[order(M[,2]),] %>% .[1:250,] %>% 
    cbind(1:nrow(.))
  Estimated_modes1_VS[i, ] <- ordered[which.max(ordered[,3]), ]
  Estimated_modes2_VS[i, ] <- ordered[which.max(ordered[,4]), ]
  Estimated_modes3_VS[i, ] <- ordered[which.max(ordered[,5]), ]

  print(i)
}
```

```{r}
Final_mode_df_VS <- Estimated_modes1_VS %>% 
  as_tibble() %>% 
  dplyr::select(V1, V2, V6) %>% 
  rename(c("Datapoint ID" = V1, "Distance to mode" = V2, "KNN index" = V6)) %>% 
  mutate(Method = "Inverse Distance") %>% 
  add_row(`Datapoint ID` = Estimated_modes2_VS[, 1], `Distance to mode` = Estimated_modes2_VS[, 2], `KNN index` = Estimated_modes2_VS[, 6], Method = "Stationary Distribution") %>% 
  add_row(`Datapoint ID` = Estimated_modes3_VS[, 1], `Distance to mode` = Estimated_modes3_VS[, 2], `KNN index` = Estimated_modes3_VS[, 6], Method = "KDE") 

 saveRDS(Final_mode_df_VS, file = "Estimated_Modes_vs_True_Data_VS.rdata")
```

All above is ground work
----------------------------------------------------------------------------------------
All Below is Analysis


```{r}
Estimated_vs_True_VS <- readRDS("Estimated_Modes_vs_True_Data_VS.rdata")

Estimated_Mode_Statistics_VS <- Estimated_vs_True_VS %>% 
    mutate(ID = rep(1:540, 3)) %>% 
  mutate(x = GMM_coordinates_VS[`Datapoint ID`, 1],
         y = GMM_coordinates_VS[`Datapoint ID`, 2],
         mu_x = rep(mu_VS[, 1], 3),
         mu_y = rep(mu_VS[, 2], 3)) %>% 
  mutate(diff_x = x-mu_x,
         diff_y = y-mu_y)

# All points around the second peak of KDE
Far_distance_VS <- Estimated_vs_True_VS %>% 
  mutate(ID = rep(1:540, 3)) %>% 
  filter(`Distance to mode` > 3) 
```

KDE has some estimated modes far away again. 
KDE mean is smaller but sd is more than 2x as large
```{r}
#Spatial distribution of estimated modes  
Estimated_vs_True_VS %>% 
  ggplot(aes(x = `KNN index`, col = `Method`)) +
  geom_density() +
  labs(title = "Distribution of which k-NN of true mode is the estimated mode")

#Shows distribution of the distance of estimated mode to the true mode
Estimated_vs_True_VS %>% 
  ggplot(aes(x = `Distance to mode`, col = Method)) +
  geom_density() +
  labs(title = "Distribution of distance to true mode")


mean_sd_above_distribution_VS <- Estimated_vs_True_VS %>% 
  group_by(Method) %>% 
  summarise(mean = mean(`Distance to mode`),
            sd = sd(`Distance to mode`))

Estimated_Mode_Statistics_VS %>% 
  filter(`Distance to mode` > 5) %>% 
  ggplot(aes(x = mu_x, y = mu_y)) +
  geom_point()

```

RGB Plot + bias/variance of spatial

```{r}
# How does estimated modes lie from the perspective of the true modes?
ggplot(Estimated_Mode_Statistics_VS, aes(x = diff_x, y = diff_y, col = Method)) +
  geom_point() +
  labs(title = "Estimated modes position from the perspective of true modes")

ggplot(Estimated_Mode_Statistics_VS, aes(x = diff_x, y = diff_y)) +
  geom_point() +
  facet_grid(~Method)

#Table of bias and standard deviation
Estimated_Mode_Statistics_VS %>% 
  group_by(Method) %>% 
  summarise(x_bias = mean(diff_x), y_bias = mean(diff_y), x_sd = sd(diff_x), y_sd = sd(diff_y))
```