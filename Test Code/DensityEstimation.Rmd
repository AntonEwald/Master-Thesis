---
title: "Density Estimation"
author: "Anton Holm"
date: '2022-02-14'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(MASS)
library(tidyverse)
library(spatstat)
library(dbscan)
library(png)
library(mvtnorm)
```

Sample from GMM similar to OSMfish data.
```{r}
set.seed(931031)

clusters = 6000
avg_genes = 200
cellwidth = 11.6
  ## A function to create a dataframe consisting of a GMM sample
  ## comparable to some in-situ sample
  
  # :Param clusters: Decides the number of cells
  # :Param avg_genes: Average number of genes per cell
  # :Param cellwidth: Used as component variance in covariance matrix (cell width in um)

  #600 different mean vectors (600 different gaussians in GMM)
  mu <-cbind(runif(clusters, 0, 2000), runif(clusters, 0, 3000))
  #Constant covariance matrix. 11.6um per cell
  Cov <- matrix(c(cellwidth, 0, 0, cellwidth), nrow = 2, ncol = 2)
  #Decide which gaussian to sample from (same probabilities)
  GMM_sample <- sample.int(clusters, clusters*avg_genes, replace = TRUE) %>% 
    table()
  # Create Sample from GMM
  gene_coord <- matrix(NA, ncol = 2, nrow = 0)
  true_dens <- matrix(NA, ncol = 1, nrow = 0)
  for (i in 1:length(GMM_sample)){
    k <- as.numeric(dimnames(GMM_sample)[[1]][i])
    mu1 <- mu[k, ]
    point <- mvrnorm(n = GMM_sample[i], mu = mu1, Sigma = Cov)
    gene_coord <- rbind(gene_coord, point)
    true_dens <- c(true_dens, dmvnorm(point, mean = mu1, sigma = Cov))
  }
```


Density estimation and comparison
```{r}
###################### Kraskov Density Estimation and comparison ###################################

# Estimation of density based on Kraskov Paper 
kraskov_estim <- function(x, N, k, d){
  exp(digamma(k) - digamma(N) - d*log(2*nndist(x, k = k)) - log(pi^(d/2)/gamma(1 + d/2)))
}

kraskov_dens <- kraskov_estim(gene_coord, N = nrow(gene_coord), k = 7, d = 2)

cor.test(rank(kraskov_dens), rank(true_dens), method = 'spearman')

rank_comparison <- ggplot(as_tibble(cbind(rank(-kraskov_dens), rank(-true_dens))), aes(x = V1, y = V2)) +
    geom_density_2d_filled(contour_var = 'ndensity') +
  labs(title = "Kraskov vs True Rank: Clusters = 6000, N = 1.2M, Var = 11.6",
       x = "Kraskov Rank",
       y = "True Rank")
ggsave(filename = "rank_comparison.png")
```

Using Gaussian Kernel with bandwidth 2.5

```{r}
kernel <- function(x, h){
  1/(2*pi*h^2) * exp(-1/2 * (x/h)^2)
}

#Calculate euclidean distance to all k-nearest neighbors (list with each gene-type in the list)
knn_distance <- kNNdist(gene_coord, k = 7, all = TRUE)

kde_dens <- kernel(knn_distance, h = 2.5) %>% 
  rowSums()

cor.test(rank(-kde_dens),rank(-true_dens), method = "spearman")

kde_vs_true <- ggplot(as_tibble(cbind(rank(-kde_dens), rank(-true_dens))), aes(x = V1, y = V2)) +
    geom_density_2d_filled(contour_var = 'ndensity') +
  labs(title = "KDE vs True Rank: Clusters = 6000, N = 1.2M, Var = 11.6",
       x = "KDE Rank",
       y = "True Rank")
ggsave(filename = "rank_comparison_kde.png")

```



Spearman vs N

```{r}
n <- c(10000, 50000, 100000, 500000, 1000000, 3000000)
spearman_ranks <- c()
clusters = 6000

for (j in 1:length(n)){
  #Decide which gaussian to sample from (same probabilities)
  GMM_sample2 <- sample.int(clusters, n[j], replace = TRUE) %>% 
    table()
  # Create Sample from GMM
  gene_coord2 <- matrix(NA, ncol = 2, nrow = 0)
  true_dens2 <- matrix(NA, ncol = 1, nrow = 0)
  kraskov_dens2 <- matrix(NA, ncol = 1, nrow = 0)
  for (i in 1:length(GMM_sample2)){
    k <- as.numeric(dimnames(GMM_sample)[[1]][i])
    mu2 <- mu[k, ]
    point2 <- rmvnorm(n = GMM_sample2[i], mean = mu2, sigma = Cov)
    gene_coord2 <- rbind(gene_coord2, point2)
    true_dens2 <- c(true_dens2, dmvnorm(point2, mean = mu2, sigma = Cov))
  }

  kraskov_dens2 <- kraskov_estim(gene_coord2, N = n[j], k = 7, d = 2)
  spearman_ranks[j] <- cor.test(rank(-true_dens2), rank(-kraskov_dens2), method = "spearman", ties.method = "average")$estimate
}

ggplot(as_tibble(n, spearman_ranks), aes(x = n, y = spearman_ranks)) +
  geom_point()

spearman_ranks
```







Some Testing

```{r}

gene_coord %>% 
  as_tibble() %>% 
  rename("x" = V1, "y" = V2) %>% 
  sample_frac(0.1) %>% 
  ggplot(aes(x, y)) + 
  geom_point()
```







Alternating size and shape of cells.
Similar results between KDE and Kraskov still
```{r}
clusters = 6000
avg_genes = 200
cellwidth = 11.6
  ## A function to create a dataframe consisting of a GMM sample
  ## comparable to some in-situ sample
  
  # :Param clusters: Decides the number of cells
  # :Param avg_genes: Average number of genes per cell
  # :Param cellwidth: Used as component variance in covariance matrix (cell width in um)

  gene_coord_diff <- matrix(NA, ncol = 2, nrow = 0)
  true_dens_diff <- matrix(NA, ncol = 1, nrow = 0)
  for (i in 1:length(GMM_sample)){
    k <- as.numeric(dimnames(GMM_sample)[[1]][i])
    mu1 <- mu[k, ]
    eps1 <- rnorm(1, 0, 1)
    eps2 <- rnorm(1, 0, 1)
    Cov_diff <- matrix(c(sqrt(cellwidth) + eps1, eps2, eps2, sqrt(cellwidth) + eps1), nrow = 2, ncol = 2)
    point_diff <- mvrnorm(n = GMM_sample[i], mu = mu1, Sigma = t(Cov_diff) %*% Cov_diff)
    gene_coord_diff <- rbind(gene_coord_diff, point_diff)
    true_dens_diff <- c(true_dens_diff, dmvnorm(point_diff, mean = mu1, sigma = Cov_diff))
  }
  
  
# Kraskov


kraskov_dens_diff <- kraskov_estim(gene_coord_diff, N = nrow(gene_coord_diff), k = 7, d = 2)

cor.test(rank(kraskov_dens_diff), rank(true_dens_diff), method = 'spearman')
  
# KDE
knn_distance_diff <- kNNdist(gene_coord_diff, k = 7, all = TRUE)

kde_dens_diff <- kernel(knn_distance_diff, h = 2.5) %>% 
  rowSums()

cor.test(rank(-kde_dens_diff),rank(-true_dens_diff), method = "spearman")

```





Make some sparse areas

```{r}
df <- gene_coord_diff %>% 
  as_tibble() %>% 
  rename("x" = V1, "y" = V2) %>% 
  mutate(true_dens = true_dens_diff)

df1 <- df %>% 
  filter(x < 700 & y < 1000) %>% 
  sample_frac(0.8)

df2 <- df %>% 
  filter(x > 1400 & y < 2000 & y > 1000) %>% 
  sample_frac(0.9)

df3 <- df %>% 
  filter(x < 700 & y > 2000) %>% 
  sample_frac(0.8)

df4 <- df %>% 
  filter(x > 1400 & y > 2000)


sparse_data <- anti_join(df, df1, by = c("x", "y")) %>% 
  anti_join(df2, by = c("x", "y")) %>% 
  anti_join(df3, by = c("x", "y")) %>% 
  anti_join(df4, by = c("x", "y")) 

sparse_data_plot <- sparse_data %>% 
  ggplot(aes(x, y)) +
    geom_density_2d_filled(contour_var = 'ndensity')
ggsave(filename = "rank_comparison_kde.png")


#Kraskov
kras_sparse <- kraskov_estim(as.matrix(sparse_data[,1:2]), N = nrow(sparse_data), k = 7, d = 2)
cor.test(rank(-kras_sparse), rank(-sparse_data$true_dens), method = 'spearman')
  
# KDE
knn_distance_sparse <- kNNdist(as.matrix(sparse_data[,1:2]), k = 7, all = TRUE)

kde_dens_sparse <- kernel(knn_distance_sparse, h = 2.5) %>% 
  rowSums()

cor.test(rank(-kde_dens_sparse),rank(-sparse_data$true_dens), method = "spearman")



```









Check if kras can find number of modes
```{r}
mu_1 <- c(-3, -3)
mu_2 <- c(-3, 3)
mu_3 <- c(3, -3)
mu_4 <- c(3, 3)
sigma <- matrix(c(1, 0, 0, 1), nrow = 2, ncol = 2)
n1 <- 1000
n2 <- 1000
n3 <- 1000
n4 <- 1000

gauss1 <- rmvnorm(n1, mu_1, sigma)
gauss2 <- rmvnorm(n2, mu_2, sigma)
gauss3 <- rmvnorm(n3, mu_3, sigma)
gauss4 <- rmvnorm(n4, mu_4, sigma)
data <- rbind(gauss1, gauss2, gauss3, gauss4)
kras1 <- kraskov_estim(data, N = nrow(data), k = 7, d = 2)

as_tibble(cbind(x = data, kras_dens = rank(kras1), true_dens = rank(c(dnorm(gauss1, mu_1, sd = sqrt(11.6)), dnorm(gauss2, mu_2, sd = sqrt(11.6)))))) %>% 
  gather("type", "value", -x) %>% 
  ggplot(aes(x = x, y = value, col = type)) +
  geom_smooth()


ggplot(as_tibble(cbind(x = data, dens = kras1)), aes(x = x, y = dens)) +
      geom_density_2d_filled(contour_var = 'ndensity')

ggplot(as_tibble(cbind(x = data, y = rank(c(dnorm(gauss1, mu_1, sd = sqrt(11.6)), dnorm(gauss2, mu_2, sd = sqrt(11.6)))))), aes(x = x, y = y)) +
  geom_density2d_filled(contour_var = "ndensity")


df <- as_tibble(cbind(x = data[,1], y = data[,2], dens = kras1))

ggplot(df, aes(x = x, y = y, col = dens)) +
  geom_point()
```

Strange that we have good rank comparison on sparse areas and worse the denser it gets. Why is that?

How do we decide on k in density estimation?

How do we estimate number of modes/peaks?